{% extends "./base.html" %}

{% block content %}
    <div class="separator"><i class="material-icons" style="color:black">person_pin</i>&nbsp;<h2 class="content-separator">Pinned Posts</h2></div>
    <div class="row pinned-posts">
        {% for post in latest_post_list %}
            {% if post.is_pinned %}
                {% if "Post" in post.kind %}
                    <!-- Blog post card -->
                    <div class="col s12 m6 l3 sortable-card" data-sort="{{ post.score }}">
                        <div class="card blue-grey darken-1 post changecolor">
                            <div class="card-content with-comments white-text post">
                                <div class="content-with-utility">
                                    <div class="card-utility">
                                        <i class="material-icons title">event_note</i>
                                        {% if request.user.is_superuser %}
                                        <i class="material-icons title fa-clickable fas fa-thumbtack tooltipped" data-position="left" data-tooltip="Click to Unpin" id="pin-btn-{{post.id}}"></i>
                                        {% endif %}
                                        {% if post.id in request.user.userprofile.favorites_id %}
                                            <i class="material-icons title fa-clickable fas fa-heart tooltipped" data-position="left" data-tooltip="Click to Unsave" id="like-btn-{{post.id}}"></i>
                                        {% else %}
                                            <i class="material-icons title fa-clickable far fa-heart tooltipped" data-position="left" data-tooltip="Click to Save" id="like-btn-{{post.id}}"></i>
                                        {% endif %}
                                    </div>
                                    <div class="card-preview-content">
                                        <span class="card-title">{{ post.title }}</span>
                                        <div class="card-description post-preview">
                                            <p>{{ post.detail|striptags|safe|truncatechars:90 }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-comments">{{ post.comment_count_string }}</div>
                            </div>
                            <div class="card-action voting">
                                <div class="score-container">
                                    <a class="btn-flat vote" style="padding-left: 0"><i id="downvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_downward</i></a>
                                    <span id="score-{{ post.id }}" class="score">{{ post.score }}</span>
                                    <a class="btn-flat vote"><i id="upvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_upward</i></a>
                                </div>
                                <a class="card-open" href="/blogs/{{ post.id }}">Open</a>
                            </div>
                        </div>
                    </div>
                    
                {% elif "Question" in post.kind %}
                    <!-- Question card -->
                    <div class="col s12 m6 l3 sortable-card" data-sort="{{ post.score }}">
                        <div class="card blue-grey darken-1 question">
                            <div class="card-content with-comments white-text" style="min-height: 201px;display: flex;flex-direction: column;justify-content: space-between;">

                                    <div class="content-with-utility">
                                        <div class="card-utility">
                                            <!-- <i class="material-icons title">event_note</i> -->
                                            <i class="material-icons title far fa-question-circle" style="font-size: 32px"></i>
                                            {% if request.user.is_superuser %}
                                            <i class="material-icons title fa-clickable fas fa-thumbtack tooltipped" data-position="left" data-tooltip="Click to Unpin" id="pin-btn-{{post.id}}"></i>
                                            {% endif %}
                                            {% if post.id in request.user.userprofile.favorites_id %}
                                                <i class="material-icons title fa-clickable fas fa-heart tooltipped" data-position="left" data-tooltip="Click to Unsave" id="like-btn-{{post.id}}"></i>
                                            {% else %}
                                                <i class="material-icons title fa-clickable far fa-heart tooltipped" data-position="left" data-tooltip="Click to Save" id="like-btn-{{post.id}}"></i>
                                            {% endif %}                                        
                                        </div>
                                        <div class="card-preview-content">
                                            <span class="card-title">{{ post.title }}</span>
                                            {% if 'Unsolved' in post.question_status %}
                                                <span class="new badge question-state unsolved" data-badge-caption=" ">{{ post.question_status }}</span>
                                            {% else %}
                                                <span class="new badge question-state" data-badge-caption=" ">{{ post.question_status }}</span>
                                            {% endif %}                                        
                                        </div>

                                    </div>
                                    <div class="card-comments">{{ post.response_count_string }}</div>
                                
                                <!-- <span class="card-title" style="display:flex;"><i class="material-icons title">question_answer</i>{{ post.title }}</span>
                                <div class="card-comments">{{ post.comment_count_string }}</div> -->
                            </div>
                            <div class="card-action voting">
                                <div class="score-container">
                                    <a class="btn-flat vote" style="padding-left: 0"><i id="downvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_downward</i></a>
                                    <span id="score-{{ post.id }}" class="score">{{ post.score }}</span>
                                    <a class="btn-flat vote"><i id="upvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_upward</i></a>
                                </div>
                                <a class="card-open" href="/blogs/{{ post.id }}">Open</a>
                            </div>
                        </div>
                    </div>
                {% elif "Image" in post.kind %}
                    <!-- Image post card -->
                    <div class="col s12 m6 l3 sortable-card" data-sort="{{ post.score }}">
                        <div class="card blue-grey darken-1">
                            <div class="card-content with-comments white-text post" style="background: linear-gradient(to right, rgba(0, 0, 0, 0.5),rgba(0, 0, 0, 0)), url('{{ post.detail }}'); background-size: cover">
                                <div class="content-with-utility">
                                    <div class="card-utility">
                                        <i class="material-icons title">event_note</i>
                                        {% if request.user.is_superuser %}
                                            <i class="material-icons title fa-clickable fas fa-thumbtack tooltipped" data-position="left" data-tooltip="Click to Unpin" id="pin-btn-{{post.id}}"></i>
                                        {% endif %}
                                        {% if post.id in request.user.userprofile.favorites_id %}
                                            <i class="material-icons title fa-clickable fas fa-heart tooltipped" data-position="left" data-tooltip="Click to Unsave" id="like-btn-{{post.id}}"></i>
                                        {% else %}
                                            <i class="material-icons title fa-clickable far fa-heart tooltipped" data-position="left" data-tooltip="Click to Save" id="like-btn-{{post.id}}"></i>
                                        {% endif %}
                                    </div>
                                    <div class="card-preview-content">
                                        <span class="card-title">{{ post.title }}</span>
                                    </div>
                                </div>
                                <div class="card-comments">{{ post.comment_count_string }}</div>
                            </div>
                            <div class="card-action voting">
                                <div class="score-container">
                                    <a class="btn-flat vote" style="padding-left: 0"><i id="downvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_downward</i></a>
                                    <span id="score-{{ post.id }}" class="score">{{ post.score }}</span>
                                    <a class="btn-flat vote"><i id="upvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_upward</i></a>
                                </div>
                                <a class="card-open" href="/blogs/{{ post.id }}">Open</a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}

    </div>

    <div class="separator" style="margin-top:0;">
        <!-- <hr style="width: 300px;margin:0;"> -->
        <i class="material-icons" style="color:black">stars</i>
        &nbsp;
        <h2 class="content-separator">Top Posts</h2>
    </div>
    <div id="top-posts-container" class="row" style="padding-bottom: 30px;">

        {% for post in latest_post_list %}
            {% if not post.is_pinned %}
                {% if "Post" in post.kind %}
                    <!-- Blog post card -->
                    <div class="col s12 m6 l4 sortable-card" data-sort="{{ post.score }}">
                        <div class="card blue-grey darken-1 post changecolor">
                            <div class="card-content with-comments white-text post">
                                <div class="content-with-utility">
                                    <div class="card-utility">
                                        <i class="material-icons title">event_note</i>
                                        {% if request.user.is_superuser %}
                                        <i class="material-icons title fa-clickable fas fa-thumbtack tooltipped" data-position="left" data-tooltip="Click to Pin" id="pin-btn-{{post.id}}"></i>
                                        {% endif %}
                                        {% if post.id in request.user.userprofile.favorites_id %}
                                            <i class="material-icons title fa-clickable fas fa-heart tooltipped" data-position="left" data-tooltip="Click to Unsave" id="like-btn-{{post.id}}"></i>
                                        {% else %}
                                            <i class="material-icons title fa-clickable far fa-heart tooltipped" data-position="left" data-tooltip="Click to Save" id="like-btn-{{post.id}}"></i>
                                        {% endif %}
                                    </div>
                                    <div class="card-preview-content">
                                        <span class="card-title">{{ post.title }}</span>
                                        <div class="card-description post-preview">
                                            <p>{{ post.detail|striptags|safe|truncatechars:90 }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-comments">{{ post.comment_count_string }}</div>
                            </div>
                            <div class="card-action voting">
                                <div class="score-container">
                                    <a class="btn-flat vote" style="padding-left: 0"><i id="downvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_downward</i></a>
                                    <span id="score-{{ post.id }}" class="score">{{ post.score }}</span>
                                    <a class="btn-flat vote"><i id="upvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_upward</i></a>
                                </div>
                                <a class="card-open waves-effect waves-light" href="/blogs/{{ post.id }}">Open</a>
                            </div>
                        </div>
                    </div>
                    
                {% elif "Question" in post.kind %}
                    <!-- Question card -->
                    <div class="col s12 m6 l4 sortable-card" data-sort="{{ post.score }}">
                        <div class="card blue-grey darken-1 question changecolor">
                            <div class="card-content with-comments white-text" style="min-height: 201px;display: flex;flex-direction: column;justify-content: space-between;">

                                    <div class="content-with-utility">
                                        <div class="card-utility">
                                            <!-- <i class="material-icons title">event_note</i> -->
                                            <i class="material-icons title far fa-question-circle" style="font-size: 32px"></i>
                                            {% if request.user.is_superuser %}
                                            <i class="material-icons title fa-clickable fas fa-thumbtack tooltipped" data-position="left" data-tooltip="Click to Pin" id="pin-btn-{{post.id}}"></i>
                                            {% endif %}
                                            {% if post.id in request.user.userprofile.favorites_id %}
                                                <i class="material-icons title fa-clickable fas fa-heart tooltipped" data-position="left" data-tooltip="Click to Unsave" id="like-btn-{{post.id}}"></i>
                                            {% else %}
                                                <i class="material-icons title fa-clickable far fa-heart tooltipped" data-position="left" data-tooltip="Click to Save" id="like-btn-{{post.id}}"></i>
                                            {% endif %}                                        
                                        </div>
                                        <div class="card-preview-content">
                                            <span class="card-title">{{ post.title }}</span>
                                            {% if 'Unsolved' in post.question_status %}
                                                <span class="new badge question-state unsolved" data-badge-caption=" ">{{ post.question_status }}</span>
                                            {% else %}
                                                <span class="new badge question-state" data-badge-caption=" ">{{ post.question_status }}</span>
                                            {% endif %}                                        
                                        </div>

                                    </div>
                                    <div class="card-comments">{{ post.response_count_string }}</div>
                                
                                <!-- <span class="card-title" style="display:flex;"><i class="material-icons title">question_answer</i>{{ post.title }}</span>
                                <div class="card-comments">{{ post.comment_count_string }}</div> -->
                            </div>
                            <div class="card-action voting">
                                <div class="score-container">
                                    <a class="btn-flat vote" style="padding-left: 0"><i id="downvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_downward</i></a>
                                    <span id="score-{{ post.id }}" class="score">{{ post.score }}</span>
                                    <a class="btn-flat vote"><i id="upvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_upward</i></a>
                                </div>
                                <a class="card-open waves-effect waves-light" href="/blogs/{{ post.id }}">Open</a>
                            </div>
                        </div>
                    </div>
                {% elif "Image" in post.kind %}

                    <!-- Image post card -->
                    <div class="col s12 m6 l4 sortable-card" data-sort="{{ post.score }}">
                        <div class="card blue-grey darken-1 changecolor">
                            <div class="card-content with-comments white-text post" style="background: linear-gradient(to right, rgba(0, 0, 0, 0.5),rgba(0, 0, 0, 0)), url('{{ post.detail }}'); background-size: cover">
                                <div class="content-with-utility">
                                    <div class="card-utility">
                                        <i class="material-icons title">event_note</i>
                                        {% if request.user.is_superuser %}
                                            <i class="material-icons title fa-clickable fas fa-thumbtack tooltipped" data-position="left" data-tooltip="Click to Pin" id="pin-btn-{{post.id}}"></i>
                                        {% endif %}
                                        {% if post.id in request.user.userprofile.favorites_id %}
                                            <i class="material-icons title fa-clickable fas fa-heart tooltipped" data-position="left" data-tooltip="Click to Unsave" id="like-btn-{{post.id}}"></i>
                                        {% else %}
                                            <i class="material-icons title fa-clickable far fa-heart tooltipped" data-position="left" data-tooltip="Click to Save" id="like-btn-{{post.id}}"></i>
                                        {% endif %}
                                    </div>
                                    <div class="card-preview-content">
                                        <span class="card-title">{{ post.title }}</span>
                                    </div>
                                </div>
                                <div class="card-comments">{{ post.comment_count_string }}</div>
                            </div>
                            <div class="card-action voting">
                                <div class="score-container">
                                    <a class="btn-flat vote" style="padding-left: 0"><i id="downvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_downward</i></a>
                                    <span id="score-{{ post.id }}" class="score">{{ post.score }}</span>
                                    <a class="btn-flat vote"><i id="upvote-{{ post.id }}" post_id="{{ post.id }}" class="material-icons">arrow_upward</i></a>
                                </div>
                                <a class="card-open waves-effect waves-light" href="/blogs/{{ post.id }}">Open</a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}

    </div>

    <script>
        //initialise tooltips
        $(document).ready(() => {
            $('.tooltipped').tooltip();
            {% for post in latest_post_list %}
                vote("{{ post.id }}", 0)
                .then(res => res.json()).then(json => {
                    if (parseInt(json.exist) === 1) {
                        document.getElementById("upvote-{{post.id}}").parentNode.classList.add('disabled');
                        document.getElementById("downvote-{{post.id}}").parentNode.classList.add('disabled');
                    }
                });
            {% endfor %}
        });

        function vote (content_id, value) {
            return fetch("{% url 'shared:vote' 9999999 %}".replace('9999999', content_id), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" },
                body: JSON.stringify({
                    'vote': value
                })
            });
        }

        document.addEventListener('click', e => {
            console.log(e.target.id);

            if (/^like-btn-/.test(e.target.id)) {
                let id = parseInt(e.target.id.match(/^like-btn-(\d+)$/)[1]);
                if (e.target.classList.contains('far')) {
                    fetch("{% url 'shared:user_like' 9999999 %}".replace('9999999', id), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" }
                    }).then(res => res.json()).then(json => {
                        if (json.message === 'Succeed') {
                            console.log(json);
                            e.target.classList.replace('far', 'fas');
                            e.target.setAttribute('data-tooltip', "Click to Unsave")
                        }
                    });
                }
                else {
                    fetch("{% url 'shared:user_unlike' 9999999 %}".replace('9999999', id), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" }
                    }).then(res => res.json()).then(json => {
                        if (json.message === 'Succeed') {
                            console.log(json);
                            e.target.classList.replace('fas', 'far');
                            e.target.setAttribute('data-tooltip', "Click to Save")
                        }
                    });
                }
            }

            if (/^pin-btn-\d+$/.test(e.target.id)) {
                let id = parseInt(e.target.id.match(/^pin-btn-(\d+)$/)[1]);
                if (e.target.getAttribute('data-tooltip') === 'Click to Pin') {
                    fetch("{% url 'blogs:pin' 9999999 %}".replace('9999999', id), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" }
                    }).then(res => {
                        if (res.status === 200) {
                            e.target.setAttribute('data-tooltip', "Click to Unpin")
                        }
                    });
                }
                else {
                    fetch("{% url 'blogs:unpin' 9999999 %}".replace('9999999', id), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" }
                    }).then(res => {
                        if (res.status === 200) {
                            e.target.setAttribute('data-tooltip', "Click to Pin")
                        }
                    });
                }
            }

            if (/^upvote-\d+$/.test(e.target.id)) {
                let id = parseInt(e.target.id.match(/^upvote-(\d+)$/)[1]);
                vote(id, 1)
                .then(res => res.json()).then(json => {
                    if ('score' in json) {
                        console.log(json);
                        document.getElementById(`upvote-${id}`).parentNode.classList.add('disabled');
                        document.getElementById(`downvote-${id}`).parentNode.classList.add('disabled');
                        document.getElementById(`score-${id}`).innerHTML = json.score;
                    }
                });
            }

            if (/^downvote-\d+$/.test(e.target.id)) {
                let id = parseInt(e.target.id.match(/^downvote-(\d+)$/)[1]);
                vote(id, -1)
                .then(res => res.json()).then(json => {
                    if ('score' in json) {
                        document.getElementById(`upvote-${id}`).parentNode.classList.add('disabled');
                        document.getElementById(`downvote-${id}`).parentNode.classList.add('disabled');
                        document.getElementById(`score-${id}`).innerHTML = json.score;
                    }
                });
            }
        });


        $(".changecolor").mouseover(function(){
            // $(this).addClass( "z-depth-3" );
            $(this).css('box-shadow', '0 8px 15px 2px rgba(0,0,0,0.4)');
        });
        $(".changecolor").mouseout(function(){
            // $(this).removeClass( "z-depth-3" );
            $(this).css('box-shadow', '0 2px 2px 0 rgba(0,0,0,0.2)');
        });
    </script>
<!--<script>-->
    <!--$(function(){-->
        <!--$("#Email").bind('input porpertychange',function(){-->
            <!--var regEmail = /^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/-->
            <!--if (regEmail.test($(this).val()) == false){-->
                <!--$('.email-error').css("display","block");-->
            <!--}-->
            <!--if (regEmail.test($(this).val())){-->
                <!--$('.email-error').css("display","none");-->
            <!--}-->
        <!--});-->


        <!--$("#repassword").bind('input porpertychange',function(){-->
            <!--if($('#repassword').val() != $('#password').val() ){-->
                <!--$('.password-error').css("display","block");-->
            <!--}-->

            <!--if($('#repassword').val() == $('#password').val() ){-->
                <!--$('.password-error').css("display","none");-->
            <!--}-->
        <!--});-->
    <!--});-->
<!--</script>-->
{% endblock %}