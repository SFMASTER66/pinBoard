{% extends "./base.html" %}

{% block content %}
    <div class="separator"><i class="material-icons" style="color:black">person_pin</i>&nbsp;<h2 class="content-separator">Pinned Posts</h2></div>
    <div class="row pinned-posts">
        {% for post in latest_post_list %}
            {% if post.is_pinned %}
                {% if "Post" in post.kind %}

                    {% block article_post_card_pinned %}
                        {% include "./article_post_card.html" %}
                    {% endblock %}
                    
                {% elif "Question" in post.kind %}

                    {% block qestion_post_card_pinned %}
                        {% include "./question_post_card.html" %}
                    {% endblock %}

                {% elif "Image" in post.kind %}

                    {% block image_post_card_pinned %}
                        {% include "./image_post_card.html" %}
                    {% endblock %}

                {% elif "Youtube" in post.kind %}

                    {% block youtube_post_card_pinned %}
                        {% include "./youtube_post_card.html" %}
                    {% endblock %}

                {% endif %}
            {% endif %}
        {% endfor %}

    </div>

    <div class="separator" style="margin-top:0;">
        <!-- <hr style="width: 300px;margin:0;"> -->
        <i class="material-icons" style="color:black">stars</i>
        &nbsp;
        <h2 class="content-separator">Top Posts</h2>
    </div>
    <div id="top-posts-container" class="row" style="padding-bottom: 30px;">

        {% for post in latest_post_list %}
            {% if not post.is_pinned %}
                {% if "Post" in post.kind %}

                    {% block article_post_card %}
                        {% include "./article_post_card.html" %}
                    {% endblock %}
                    
                {% elif "Question" in post.kind %}

                    {% block question_post_card %}
                        {% include "./question_post_card.html" %}
                    {% endblock %}

                {% elif "Image" in post.kind %}

                    {% block image_post_card %}
                        {% include "./image_post_card.html" %}
                    {% endblock %}

                {% elif "Youtube" in post.kind %}

                    {% block youtube_post_card %}
                        {% include "./youtube_post_card.html" %}
                    {% endblock %}

                {% endif %}
            {% endif %}
        {% endfor %}

    </div>

    <script>
        //initialise tooltips
        $(document).ready(() => {
            $('.tooltipped').tooltip();
            {% for post in latest_post_list %}
                vote("{{ post.id }}", 0)
                .then(res => res.json()).then(json => {
                    if (parseInt(json.exist) === 1) {
                        document.getElementById("upvote-{{post.id}}").parentNode.classList.add('disabled');
                        document.getElementById("downvote-{{post.id}}").parentNode.classList.add('disabled');
                    }
                });
            {% endfor %}
        });

        function vote (content_id, value) {
            return fetch("{% url 'shared:vote' 9999999 %}".replace('9999999', content_id), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" },
                body: JSON.stringify({
                    'vote': value
                })
            });
        }

        document.addEventListener('click', e => {
            console.log(e.target.id);

            if (/^like-btn-/.test(e.target.id)) {
                let id = parseInt(e.target.id.match(/^like-btn-(\d+)$/)[1]);
                if (e.target.classList.contains('far')) {
                    fetch("{% url 'shared:user_like' 9999999 %}".replace('9999999', id), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" }
                    }).then(res => res.json()).then(json => {
                        if (json.message === 'Succeed') {
                            console.log(json);
                            e.target.classList.replace('far', 'fas');
                            e.target.setAttribute('data-tooltip', "Click to Unsave")
                        }
                    });
                }
                else {
                    fetch("{% url 'shared:user_unlike' 9999999 %}".replace('9999999', id), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" }
                    }).then(res => res.json()).then(json => {
                        if (json.message === 'Succeed') {
                            console.log(json);
                            e.target.classList.replace('fas', 'far');
                            e.target.setAttribute('data-tooltip', "Click to Save")
                        }
                    });
                }
            }

            if (/^pin-btn-\d+$/.test(e.target.id)) {
                let id = parseInt(e.target.id.match(/^pin-btn-(\d+)$/)[1]);
                if (e.target.getAttribute('data-tooltip') === 'Click to Pin') {
                    fetch("{% url 'blogs:pin' 9999999 %}".replace('9999999', id), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" }
                    }).then(res => {
                        if (res.status === 200) {
                            e.target.setAttribute('data-tooltip', "Click to Unpin")
                        }
                    });
                }
                else {
                    fetch("{% url 'blogs:unpin' 9999999 %}".replace('9999999', id), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}" }
                    }).then(res => {
                        if (res.status === 200) {
                            e.target.setAttribute('data-tooltip', "Click to Pin")
                        }
                    });
                }
            }

            if (/^upvote-\d+$/.test(e.target.id)) {
                let id = parseInt(e.target.id.match(/^upvote-(\d+)$/)[1]);
                vote(id, 1)
                .then(res => res.json()).then(json => {
                    if ('score' in json) {
                        console.log(json);
                        document.getElementById(`upvote-${id}`).parentNode.classList.add('disabled');
                        document.getElementById(`downvote-${id}`).parentNode.classList.add('disabled');
                        document.getElementById(`score-${id}`).innerHTML = json.score;
                    }
                });
            }

            if (/^downvote-\d+$/.test(e.target.id)) {
                let id = parseInt(e.target.id.match(/^downvote-(\d+)$/)[1]);
                vote(id, -1)
                .then(res => res.json()).then(json => {
                    if ('score' in json) {
                        document.getElementById(`upvote-${id}`).parentNode.classList.add('disabled');
                        document.getElementById(`downvote-${id}`).parentNode.classList.add('disabled');
                        document.getElementById(`score-${id}`).innerHTML = json.score;
                    }
                });
            }
        });


        $(".changecolor").mouseover(function(){
            // $(this).addClass( "z-depth-3" );
            $(this).css('box-shadow', '0 8px 15px 2px rgba(0,0,0,0.4)');
        });
        $(".changecolor").mouseout(function(){
            // $(this).removeClass( "z-depth-3" );
            $(this).css('box-shadow', '0 2px 2px 0 rgba(0,0,0,0.2)');
        });
    </script>
<!--<script>-->
    <!--$(function(){-->
        <!--$("#Email").bind('input porpertychange',function(){-->
            <!--var regEmail = /^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/-->
            <!--if (regEmail.test($(this).val()) == false){-->
                <!--$('.email-error').css("display","block");-->
            <!--}-->
            <!--if (regEmail.test($(this).val())){-->
                <!--$('.email-error').css("display","none");-->
            <!--}-->
        <!--});-->


        <!--$("#repassword").bind('input porpertychange',function(){-->
            <!--if($('#repassword').val() != $('#password').val() ){-->
                <!--$('.password-error').css("display","block");-->
            <!--}-->

            <!--if($('#repassword').val() == $('#password').val() ){-->
                <!--$('.password-error').css("display","none");-->
            <!--}-->
        <!--});-->
    <!--});-->
<!--</script>-->
{% endblock %}